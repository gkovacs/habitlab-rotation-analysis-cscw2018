---
title: "HabitLab analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.



Loading in data:

```{r}
library(fitdistrplus)
library(ez)
library(lme4)

basepath = '/Users/msb/Dropbox (Stanford HCI)/projects/habitlab/'
#basepath = '/home/geza/habitlab_data_analysis/'
datadays_filename = paste(basepath, 'data_april3_1am_days.csv', sep='')
data_filename = paste(basepath, 'data_april3_1am.csv', sep='')

datadays <- read.csv(datadays_filename)
datadays$attritioned_today <- datadays$attritioned_today == 1
datadays$attritioned <- datadays$attritioned == 1
datadays$is_last_day <- datadays$is_last_day == 1
datadays$is_day_with_just_one_sample <- datadays$is_day_with_just_one_sample == 1
datadays$user_saw_both_same_and_random <- datadays$user_saw_both_same_and_random == 1
summary(datadays)
```

Reading in the per-session data:
```{r}
data <- read.csv(data_filename)
data$attritioned <- data$attritioned == 1
data$is_first_visit_of_day <- data$is_first_visit_of_day == 1
data$is_day_with_just_one_sample <- data$is_day_with_just_one_sample == 1

summary(data)
```


Filter to Facebook data

```{r}
datadays_facebook <- subset(datadays, datadays$domain == "www.facebook.com")
datadays_facebook <- subset(datadays_facebook, datadays_facebook$intervention == 'random' | datadays_facebook$intervention == 'facebook/feed_injection_timer' | datadays_facebook$intervention == "facebook/remove_news_feed" | datadays_facebook$intervention == "facebook/remove_comments" | datadays_facebook$intervention == 'facebook/toast_notifications' | datadays_facebook$intervention == 'facebook/show_timer_banner')

data_facebook <- subset(data, domain == "www.facebook.com")
data_facebook <- subset(data_facebook, intervention == 'random' | intervention == 'facebook/feed_injection_timer' | intervention == "facebook/remove_news_feed" | intervention == "facebook/remove_comments" | intervention == 'facebook/toast_notifications' | intervention == 'facebook/show_timer_banner')
```



Exclude first and last days (incomplete observations) when analyzing at the day level

```{r}
datadays_nofirstlast <- subset(datadays, days_since_install > 0 & days_until_last_day > 0)
datadays_facebook_nofirstlast <- subset(datadays_facebook, days_since_install > 0 & days_until_last_day > 0)
```

Number of users in dataset

```{r}
length(unique(data$userid))
length(unique(datadays$userid))
length(unique(datadays_nofirstlast$userid))
length(unique(datadays_facebook$userid))
length(unique(datadays_facebook_nofirstlast$userid))
```


*SIGNIFICANT* Does condition have effect on attrition rates at the day level overall?

```{r}
results <- glmer(attritioned ~ condition + (1|install_id), family=binomial(link='logit'), data = datadays)
resultsnull <- glmer(attritioned ~ (1|install_id), family=binomial(link='logit'), data = datadays)
anova(resultsnull, results)
summary(results)

print("Odds ratios")
rtab <- exp(fixef(results))
print(rtab,digits=3)
```

*SIGNIFICANT* Does condition have effect on attrition rates at the day level, on Facebook?

```{r}
results <- glmer(attritioned ~ condition + (1|install_id), family=binomial(link='logit'), data = datadays_facebook)
resultsnull <- glmer(attritioned ~ (1|install_id), family=binomial(link='logit'), data = datadays_facebook)
anova(resultsnull, results)
summary(results)

print("Odds ratios")
rtab <- exp(fixef(results))
print(rtab,digits=3)
```



*SIGNIFICANT* Does condition have an effect on attrition rates at the session level?

```{r}
results <- glmer(attritioned ~ condition + (1|install_id), family=binomial(link='logit'), data = data)
resultsnull <- glmer(attritioned ~ (1|install_id), family=binomial(link='logit'), data = data)
anova(resultsnull, results)
summary(results)

print("Odds ratios")
rtab <- exp(fixef(results))
print(rtab,digits=3)
```


*SIGNIFICANT* Does condition have an effect on attrition rates at the session level, on Facebook?

```{r}
results <- glmer(attritioned ~ condition + intervention + (1|install_id), family=binomial(link='logit'), data = data_facebook)
resultsnull <- glmer(attritioned ~ intervention + (1|install_id), family=binomial(link='logit'), data = data_facebook)
anova(resultsnull, results)
summary(results)

print("Odds ratios")
rtab <- exp(fixef(results))
print(rtab,digits=3)
```

Does condition duration have an effect on attrition rates at the day level?

```{r}
results <- glmer(attritioned ~ as.factor(conditionduration) + condition + (1|install_id), family=binomial(link='logit'), data = datadays)
resultsnull <- glmer(attritioned ~ condition + (1|install_id), family=binomial(link='logit'), data = datadays)
anova(resultsnull, results)
summary(results)
```

Does condition duration have an effect on attrition rates at the day level on Facebook?

```{r}
results <- glmer(attritioned ~ as.factor(conditionduration) + condition + (1|install_id), family=binomial(link='logit'), data = datadays_facebook)
resultsnull <- glmer(attritioned ~ condition + (1|install_id), family=binomial(link='logit'), data = datadays_facebook)
anova(resultsnull, results)
summary(results)
```

Does condition duration have an effect on attrition rates at the session level?

```{r}
results <- glmer(attritioned ~ as.factor(conditionduration) + condition + (1|install_id), family=binomial(link='logit'), data = data)
resultsnull <- glmer(attritioned ~ condition + (1|install_id), family=binomial(link='logit'), data = data)
anova(resultsnull, results)
summary(results)
```

Does condition duration have an effect on attrition rates at the session level on Facebook?

```{r}
results <- glmer(attritioned ~ as.factor(conditionduration) + condition + intervention + (1|install_id), family=binomial(link='logit'), data = data_facebook)
resultsnull <- glmer(attritioned ~ condition + intervention + (1|install_id), family=binomial(link='logit'), data = data_facebook)
anova(resultsnull, results)
summary(results)
```

*SIGNIFICANT* Does condition have an effect on time spent per day?

```{r}
results <- lmer(log_time_spent ~ condition + domain + (1|install_id), data = datadays_nofirstlast)
resultsnull <- lmer(log_time_spent ~ domain + (1|install_id), data = datadays_nofirstlast)
anova(resultsnull, results)
summary(results)
```

Does condition have an effect on time spent on Facebook per day?

```{r}
results <- lmer(log_time_spent ~ condition + (1|install_id), data = datadays_facebook_nofirstlast)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = datadays_facebook_nofirstlast)
anova(resultsnull, results)
summary(results)
```

Does condition have an effect on time spent per session on Facebook?

```{r}
results <- lmer(log_time_spent ~ condition + intervention + (1|install_id), data = data_facebook)
resultsnull <- lmer(log_time_spent ~ intervention + (1|install_id), data = data_facebook)
anova(resultsnull, results)
summary(results)
```

*SIGNIFICANT* Does intervention have an effect on time spent per session on Facebook?

```{r}
results <- lmer(log_time_spent ~ intervention + (1|install_id), data = data_facebook)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = data_facebook)
anova(resultsnull, results)
summary(results)
```

*SIGNIFICANT* Do interventions decrease in effectiveness over time on Facebook?

```{r}
results <- lmer(log_time_spent ~ num_days_intervention_seen_at_least_once + intervention + (1|install_id), data = data_facebook)
resultsnull <- lmer(log_time_spent ~ intervention + (1|install_id), data = data_facebook)
anova(resultsnull, results)
summary(results)
```

*SIGNIFICANT* Do interventions decrease in effectiveness over time on Facebook?

```{r}
results <- lmer(log_time_spent ~ impression_idx + is_first_visit_of_day + intervention + (1|install_id), data = data_facebook)
resultsnull <- lmer(log_time_spent ~ is_first_visit_of_day + intervention + (1|install_id), data = data_facebook)
anova(resultsnull, results)
summary(results)
```

Do interventions decrease in effectiveness over time on all sites?

```{r}
results <- lmer(log_time_spent ~ num_days_intervention_seen_at_least_once + intervention + (1|install_id), data = data)
resultsnull <- lmer(log_time_spent ~ intervention + (1|install_id), data = data)
anova(resultsnull, results)
summary(results)
```

*SIGNIFICANT* Do interventions decrease in effectiveness over time on all sites?

```{r}
results <- lmer(log_time_spent ~ impression_idx + is_first_visit_of_day + intervention + (1|install_id), data = data)
resultsnull <- lmer(log_time_spent ~ is_first_visit_of_day + intervention + (1|install_id), data = data)
anova(resultsnull, results)
summary(results)
```

Does condition duration within the same condition have effect on time spent per session on Facebook?

```{r}
curdata <- subset(data_facebook, condition == 'same')
results <- lmer(log_time_spent ~ as.factor(conditionduration) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)
```

Does condition duration within the random condition have effect on time spent per session on Facebook?

```{r}
curdata <- subset(data_facebook, condition == 'random')
results <- lmer(log_time_spent ~ as.factor(conditionduration) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)
```

Does condition duration within the same condition have effect on time spent per day on Facebook?

```{r}
curdata <- subset(datadays_facebook_nofirstlast, condition == 'same')
results <- lmer(log_time_spent ~ as.factor(conditionduration) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)
```

Does condition duration within the same condition have effect on time spent per day on Facebook?

```{r}
curdata <- subset(datadays_facebook_nofirstlast, condition == 'same')
results <- lmer(log_time_spent ~ intervention + conditionduration + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ intervention + (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)
```

*SIGNIFICANT* Does condition duration within the same condition have effect on time spent per day on all sites?

```{r}
curdata <- subset(datadays_nofirstlast, condition == 'same')
results <- lmer(log_time_spent ~ conditionduration + intervention + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ intervention + (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)
```



Does condition duration within the random condition have effect on time spent per day on Facebook?

```{r}
curdata <- subset(datadays_facebook, condition == 'random')
results <- lmer(log_time_spent ~ as.factor(conditionduration) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)
```

*SIGNIFICANT* Does difference between random and same conditions increase with condition durations?

```{r}
curdata <- subset(datadays_nofirstlast, conditionduration == 1)
results <- lmer(log_time_spent ~ as.factor(condition) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)

curdata <- subset(datadays_nofirstlast, conditionduration == 3)
results <- lmer(log_time_spent ~ as.factor(condition) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)

curdata <- subset(datadays_nofirstlast, conditionduration == 5)
results <- lmer(log_time_spent ~ as.factor(condition) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)

curdata <- subset(datadays_nofirstlast, conditionduration == 7)
results <- lmer(log_time_spent ~ as.factor(condition) + (1|install_id), data = curdata)
resultsnull <- lmer(log_time_spent ~ (1|install_id), data = curdata)
anova(resultsnull, results)
summary(results)
```




